{% extends "base.html" %}
{% block title %}
{{title_name}}
{% endblock %}
{% block content %}
<link rel="stylesheet" href="/static/verification/verifications_control/css/view.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">

<div class="container-fluid verification-page px-3">
  <h1 class="text-center mb-5">{{title_name}}</h1>
  <div class="container-statistic">
    <div class="row justify-content-center gap-3 d-flex flex-column flex-md-row">
      <div class="col-md-3 box flex-grow-1" id="total-entries-box">
        Всего записей поверок: <span id="total-entries">0</span>
      </div>
      <div class="col-md-3 box flex-grow-1">
        Пригодно: <span id="verified-entry">0</span>
      </div>
      <div class="col-md-3 box flex-grow-1">
        Непригодно: <span id="not-verified-entry">0</span>
      </div>
    </div>
  </div>

  <div class="container-filter">
    <h2 class="text-start mb-4">Фильтр отображаемых записей</h2>

    <form id="filter-form">
      <div class="row py-2 px-1" style="border: 2px solid #858181; background: #dddcdcbb; border-radius: 20px;">

        <div class="col-md-3 mb-3 flex-grow-1">
          <label for="date_from" class="form-label">Дата с</label>
          <input type="date" id="date_from" name="date_from" class="form-control" />
        </div>

        <div class="col-md-3 mb-3 flex-grow-1">
          <label for="date_to" class="form-label">По</label>
          <input type="date" id="date_to" name="date_to" class="form-control" />
        </div>

        <div class="col-md-3 mb-3 flex-grow-1">
          <label for="client_address" class="form-label">Адрес</label>
          <input type="text" id="client_address" name="client_address" class="form-control"
            placeholder="Введите адрес" />
        </div>

        <div class="col-md-3 mb-3 flex-grow-1">
          <label for="factory_number" class="form-label">Заводской номер</label>
          <input type="text" id="factory_number" name="factory_number" class="form-control"
            placeholder="Введите заводской номер" />
        </div>

        <div class="col-md-3 mb-3 flex-grow-1">
          <label for="series_id" class="form-label">Серия бланка</label>
          <select id="series_id" name="series_id" class="form-select">
            <option value="">Выберите серию бланка</option>
            {% for s in series %}
            <option value="{{ s.id }}">{{ s.name }}</option>
            {% endfor %}
          </select>
        </div>

        {% if status in ["admin", "director", "auditor"] %}
        <div class="col-md-3 mb-3 flex-grow-1">
          <label for="employee_id" class="form-label">Работник</label>
          <select id="employee_id" name="employee_id" class="form-select">
            <option value="">Выберите работника</option>
            {% for employee in employees %}
            <option value="{{ employee.id }}">
              {{ employee.last_name | capitalize }} {{ employee.name | capitalize }} {{ employee.patronymic | capitalize
              }}
            </option>
            {% endfor %}
          </select>
        </div>
        {% endif %}

        {% if status in ["admin", "director", "auditor"] %}
        <div class="col-md-3 mb-3 flex-grow-1">
          <label for="client_phone" class="form-label">Номер телефона</label>
          <input type="tel" id="client_phone" name="client_phone" class="form-control" maxlength="18" />
        </div>
        {% endif %}

        <div class="col-md-3 mb-3 flex-grow-1">
          <label for="city_id" class="form-label">Город</label>
          <select id="city_id" name="city_id" class="form-select">
            <option value="">Выберите город</option>
            {% for city in cities %}
            <option value="{{ city.id }}">{{ city.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3 mb-3 flex-grow-1">
          <label for="water_type" class="form-label">Вода</label>
          <select id="water_type" name="water_type" class="form-select">
            <option value="">Выберите тип воды</option>
            <option value="cold">Холодная</option>
            <option value="hot">Горячая</option>
          </select>
        </div>

        <div class="col-md-3 mb-3 flex-grow-1">
          <label for="act_number" class="form-label">Номер бланка</label>
          <input type="number" id="act_number" name="act_number" class="form-control"
            placeholder="Введите номер бланка" />
        </div>

      </div>

      <div class="d-flex justify-content-center mt-2 mb-1">
        <button type="submit" class="btn btn-outline-dark mx-3 w-100 d-inline-block text-truncate fw-bold"
          style="border: 2px solid black">Отобрать</button>

        <button type="button" id="reset-filters"
          class="btn btn-outline-dark mx-3 w-100 d-inline-block text-truncate fw-bold"
          style="border: 2px solid black">Сбросить фильтр</button>
      </div>
    </form>
  </div>

  <div class="container-workplace" style="min-width: 0;">
    <div class="row py-2 px-1">
      {% if status != "auditor" and status != "verifier"%}
      <div class="col-md-6 mb-3 flex-grow-1">
        <a class="btn btn-success w-100 d-inline-block text-truncate fw-bold"
          href="/verification/reports/employees/?company_id={{company_id}}"
          style="border: 2px solid black">Сотрудники</a>
      </div>

      <div class="col-md-6 mb-3 flex-grow-1">
        <a class="btn btn-success w-100 d-inline-block text-truncate fw-bold"
          href="/verification/reports/cities/?company_id={{company_id}}" style="border: 2px solid black">Населенные
          пункты</a>
      </div>
      {% endif %}
      {% if status != "verifier"%}
      <!-- Общий отчёт -->
      <div class="col-md-3 mb-3 flex-grow-1">
        <button id="full-report-btn" type="button" class="btn btn-primary w-100 d-inline-block text-truncate fw-bold"
          style="border: 2px solid black">Общий отчёт</button>
      </div>
      {% endif %}
      {% if status != "auditor" and status != "verifier"%}

      <div class="col-md-3 mb-3 flex-grow-1">
        <a id="btn-print-protocols" class="btn btn-primary w-100 d-inline-block text-truncate fw-bold"
          style="border: 2px solid black">Печать протоколов</a>
      </div>

      <!-- Отчет в ФИФ -->
      <div class="col-md-3 mb-3 flex-grow-1">
        <button id="fif-report-btn" type="button" class="btn btn-primary w-100 d-inline-block text-truncate fw-bold"
          style="border: 2px solid black">Отчет в ФИФ</button>
      </div>

      <!-- Отчет в РА -->
      <div class="col-md-3 mb-3 flex-grow-1">
        <button id="ra-report-btn" type="button" class="btn btn-primary w-100 d-inline-block text-truncate fw-bold"
          style="border: 2px solid black">Отчет в РА</button>
      </div>

      <!-- ФГИС "АРШИН" -->
      <div class="col-md-4 mb-3 flex-grow-1">
        <button id="arshin-btn" type="button" class="btn btn-primary w-100 d-inline-block text-truncate fw-bold"
          style="border: 2px solid black">
          ФГИС "АРШИН"
        </button>
      </div>

      <!-- Статистика по эталонам -->
      <div class="col-md-4 mb-3 flex-grow-1">
        <button id="equipment-stats-btn" type="button"
          class="btn btn-primary w-100 d-inline-block text-truncate fw-bold" style="border: 2px solid black">Статистика
          по эталонам</button>
      </div>

      <div class="col-md-4 mb-3 flex-grow-1">
        <a class="btn btn-primary w-100 d-inline-block text-truncate fw-bold"
          href="/verification/reports/act-numbers/?company_id={{company_id}}" style="border: 2px solid black">Статистика
          по номерам бланка</a>
      </div>

      <!-- Форма загрузки файла для FIF -->
      <form action="/verification/api/reports/fund?company_id={{company_id}}" method="post"
        enctype="multipart/form-data" class="flex-grow-1 mb-3" style="display: flex; align-items: center; width: 100%;">
        <input type="file" class="form-control" name="file" id="fileInput" required
          style="width: 63%; margin-right: 2%;">
        <button type="submit" class="btn btn-success d-inline-block text-truncate fw-bold"
          style="width: 35%;">Загрузить</button>
      </form>
      {% endif %}

      <!-- Динамические отчеты -->
      {% for report in reports %}
      {% if (status in ["auditor"] and report.for_auditor) or (status in ["verifier"] and report.for_verifier) or
      (status not in ["auditor", "verifier"])%}
      <div class="col-md-4 mb-3 flex-grow-1">
        <button type="button" class="btn btn-info w-100 d-inline-block text-truncate fw-bold"
          data-report-id="{{ report.id }}" style="border: 2px solid black">{{ report.name }}</button>
      </div>
      {% endif %}
      {% endfor %}
    </div>
  </div>

  <div id="table-block" class="mb-4 fs-4 d-flex justify-content-center align-items-center">
    <label for="limit" class="form-label me-2">Показывать на странице</label>
    <select id="limit" class="form-select" style="width: auto;">
      <option selected value="30">30</option>
      <option value="50">50</option>
      <option value="100">100</option>
    </select>
  </div>

  <div class="table-shell">
    <div class="table-scroll">
      <table class="table table-bordered table-striped align-middle mb-0">
        <thead class="table-dark">
          <tr>
            <th class="text-center align-middle col-40">#</th>
            <th class="text-center align-middle col-120">ФИО сотрудника</th>
            <th class="text-center align-middle col-120">Дата поверки</th>
            <th class="text-center align-middle col-120">Город</th>
            <th class="text-center align-middle col-150">Адрес</th>
            <th class="text-center align-middle col-120">ФИО клиента</th>
            <th class="text-center align-middle col-150">Тип СИ</th>
            <th class="text-center align-middle col-120">№ Госреестра</th>
            <th class="text-center align-middle col-100">Модификация СИ</th>
            <th class="text-center align-middle col-120">Заводской номер</th>
            <th class="text-center align-middle col-100">Место расположения счетчика</th>
            <th class="text-center align-middle col-100">Показания счетчика</th>
            <th class="text-center align-middle col-100">Срок окончания поверки</th>
            <th class="text-center align-middle col-100">Серия бланка</th>
            <th class="text-center align-middle col-100">Номер бланка</th>
            <th class="text-center align-middle col-100">Результат поверки</th>
            <th class="text-center align-middle col-100">Вода</th>
            <th class="text-center align-middle col-100">Наличие пломбы</th>
            <th class="text-center align-middle col-100">Год выпуска</th>
            <th class="text-center align-middle col-100">Дата создания</th>
            <th class="text-center align-middle col-100">Дата обновления</th>
            <th class="text-center align-middle col-100">Протокол</th>
          </tr>
        </thead>
        <tbody id="verification-table-body">
          <tr>
            <td colspan="22" class="text-center">Загрузка данных...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <nav id="pagination-block" class="mt-3" style="font-size: calc(8px + 0.5vw);"></nav>
</div>

<script src="https://cdn.jsdelivr.net/npm/imask@7.6.0/dist/imask.min.js"></script>

<script>
  window.company_id = {{ company_id }};
</script>

<script src="/static/verification/verifications_control/js/view.js"></script>
{% endblock %}